-- #############################################################################
-- #                                                                           #
-- #          NİHAİ PROJE VERİTABANI ŞEMASI (DOKÜMANTASYON VERSİYONU)            #
-- #                                                                           #
-- #############################################################################


-- #############################################################################
-- # BÖLÜM 1: ÖZEL VERİ TİPLERİ (ENUMS)
-- #############################################################################
-- Not: Bu bölüm, veritabanında belirli alanların alabileceği değerleri kısıtlayarak
-- veri bütünlüğünü sağlar.

-- Sipariş durumlarını yönetmek için bir ENUM tipi oluşturuyoruz.
CREATE TYPE public.order_status AS ENUM (
  'pending',     -- Sipariş alındı, onay bekliyor
  'confirmed',   -- Sipariş onaylandı, işleme alınacak
  'processing',  -- Sipariş hazırlanıyor
  'shipped',     -- Sipariş kargoya verildi
  'delivered',   -- Sipariş teslim edildi
  'cancelled'    -- Sipariş iptal edildi
);


-- #############################################################################
-- # BÖLÜM 2: KULLANICI YÖNETİMİ VE YETKİLENDİRME TABLOLARI
-- #############################################################################
-- Not: Bu tablolar, projenin kullanıcı rolleri ve yetkilendirme sisteminin temelini oluşturur.

-- Uygulamadaki kullanıcı rollerini tanımlar (admin, montajcı, müşteri).
CREATE TABLE public.roles (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Supabase'in `auth.users` tablosunu genişleten profil tablosu.
-- Her kullanıcıya ait rol, isim gibi uygulama özelindeki verileri tutar.
CREATE TABLE public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  first_name TEXT,
  last_name TEXT,
  role_id BIGINT NOT NULL REFERENCES public.roles(id),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);


-- #############################################################################
-- # BÖLÜM 3: ÜRÜN KATALOĞU TABLOLARI
-- #############################################################################
-- Not: Bu tablolar, e-ticaret sitesinin ürün yapısını ve içeriğini yönetir.

-- Markalar tablosu.
CREATE TABLE public.brands (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  slug TEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Kategoriler tablosu. `parent_id` ile hiyerarşik yapı (alt kategoriler) desteklenir.
CREATE TABLE public.categories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  slug TEXT NOT NULL UNIQUE,
  emoji TEXT,
  parent_id UUID REFERENCES public.categories(id) ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Ürünler tablosu. Fiyatlar için `NUMERIC` tipi kullanılarak ondalık hassasiyeti korunur.
CREATE TABLE public.products (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  slug TEXT NOT NULL UNIQUE,
  description TEXT,
  price NUMERIC(10, 2) NOT NULL CHECK (price >= 0),
  discount_price NUMERIC(10, 2) CHECK (discount_price >= 0),
  stock INT NOT NULL DEFAULT 0 CHECK (stock >= 0),
  stock_code TEXT,
  brand_id UUID REFERENCES public.brands(id) ON DELETE SET NULL,
  category_id UUID REFERENCES public.categories(id) ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  -- İndirimli fiyatın normal fiyattan düşük olmasını garanti eden kural.
  CONSTRAINT chk_discount_price CHECK (discount_price IS NULL OR discount_price < price)
);

-- Ürünlere ait çoklu görselleri tutan tablo.
-- Kapak resmi bilgisi `is_cover` alanı ile "tek doğru kaynak" olarak burada tutulur.
CREATE TABLE public.product_images (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id UUID NOT NULL REFERENCES public.products(id) ON DELETE CASCADE,
  image_url TEXT NOT NULL CHECK (image_url <> ''),
  order_index INT NOT NULL DEFAULT 0,
  is_cover BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Ana sayfa gibi yerlerde kullanılacak banner'ları yönetir.
CREATE TABLE public.banners (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT,
  image_url TEXT,
  link TEXT,
  order_index INT NOT NULL DEFAULT 0,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);


-- #############################################################################
-- # BÖLÜM 4: SEPET VE SİPARİŞ SÜRECİ TABLOLARI
-- #############################################################################
-- Not: Bu tablolar, kullanıcının alışveriş sürecini baştan sona yönetir.

-- Hem misafir (session_id ile) hem de giriş yapmış kullanıcıların (user_id ile) sepetlerini yönetir.
CREATE TABLE public.carts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  session_id TEXT UNIQUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  expires_at TIMESTAMPTZ NOT NULL DEFAULT NOW() + INTERVAL '7 days',
  -- Bir sepetin ya bir kullanıcıya ya da bir session'a ait olmasını garanti eder.
  CONSTRAINT chk_user_or_session CHECK (user_id IS NOT NULL OR session_id IS NOT NULL)
);

-- Sepet içeriğini yönetir. `price` alanı, ürünün sepete eklendiği andaki fiyatını saklar.
CREATE TABLE public.cart_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  cart_id UUID NOT NULL REFERENCES public.carts(id) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES public.products(id) ON DELETE CASCADE,
  quantity INT NOT NULL CHECK (quantity > 0),
  price NUMERIC(10, 2) NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  -- Bir sepette aynı üründen sadece bir satır olmasını sağlar.
  UNIQUE(cart_id, product_id)
);

-- Siparişler tablosu. `order_number` ile her siparişe benzersiz bir numara verilir.
CREATE TABLE public.orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_number TEXT NOT NULL UNIQUE,
  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  status public.order_status NOT NULL DEFAULT 'pending',
  total_amount NUMERIC(10, 2) NOT NULL CHECK (total_amount >= 0),
  customer_name TEXT NOT NULL,
  customer_email TEXT NOT NULL,
  customer_phone TEXT,
  shipping_province TEXT NOT NULL,
  shipping_district TEXT NOT NULL,
  shipping_postal_code TEXT,
  shipping_address TEXT NOT NULL,
  billing_province TEXT,
  billing_district TEXT,
  billing_postal_code TEXT,
  billing_address TEXT,
  notes TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Sipariş kalemleri tablosu. Ürün bilgileri değişse bile sipariş anındaki veriyi korur.
CREATE TABLE public.order_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE,
  product_id UUID REFERENCES public.products(id) ON DELETE SET NULL,
  product_name TEXT NOT NULL, -- Sipariş anındaki ürün adı
  product_slug TEXT,
  quantity INT NOT NULL CHECK (quantity > 0),
  unit_price NUMERIC(10, 2) NOT NULL, -- Sipariş anındaki birim fiyat
  total_price NUMERIC(10, 2) NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);


-- #############################################################################
-- # BÖLÜM 5: PERFORMANS İÇİN INDEX'LER
-- #############################################################################
-- Not: Sıkça sorgulanan veya `JOIN` işlemlerinde kullanılan alanlara index eklemek performansı artırır.

CREATE INDEX IF NOT EXISTS idx_profiles_role_id ON public.profiles(role_id);
CREATE INDEX IF NOT EXISTS idx_products_slug ON public.products(slug);
CREATE INDEX IF NOT EXISTS idx_products_brand_id ON public.products(brand_id);
CREATE INDEX IF NOT EXISTS idx_products_category_id ON public.products(category_id);
CREATE INDEX IF NOT EXISTS idx_categories_slug ON public.categories(slug);
CREATE INDEX IF NOT EXISTS idx_categories_parent_id ON public.categories(parent_id);
CREATE INDEX IF NOT EXISTS idx_product_images_product_id ON public.product_images(product_id);
CREATE INDEX IF NOT EXISTS idx_carts_user_id ON public.carts(user_id);
CREATE INDEX IF NOT EXISTS idx_cart_items_cart_id ON public.cart_items(cart_id);
CREATE INDEX IF NOT EXISTS idx_orders_user_id ON public.orders(user_id);
CREATE INDEX IF NOT EXISTS idx_orders_status ON public.orders(status);
CREATE INDEX IF NOT EXISTS idx_order_items_order_id ON public.order_items(order_id);


-- #############################################################################
-- # BÖLÜM 6: SATIR SEVİYESİ GÜVENLİK (ROW LEVEL SECURITY - RLS)
-- #############################################################################
-- Not: Bu komutlar, tablolarda RLS'yi etkinleştirir. "Kullanıcılar sadece kendi verilerini
-- görebilir" gibi politikaların daha sonra eklenmesi için bir ön hazırlıktır.

ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.carts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.cart_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.order_items ENABLE ROW LEVEL SECURITY;